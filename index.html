<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>徐明君的个人主页/Xu Mingjun's HomePage</title>
<link rel="stylesheet" type="text/css" href="css/common.css" />
<link rel="stylesheet" type="text/css" href="css/icon.css" />

<style type="text/css">

    img#me {
    	padding: 5px;
    	float:right;
    }
    ul.follow {
    	display: inline-block;
    	vertical-align: text-bottom;
    	margin: 0;
    	padding: 0;
    }
    ul.follow>li {
     	display: inline;
    }
    ul.follow img {
     	width: 24px;
     	height: 24px;
    }
    ul.follow a:hover {
     	text-decoration: none;
    }

    ul#interest>li {
     	vertical-align:top;
     	display: inline-block;
     	width: 450px;
     	height: 200px;
     	margin: 2px 1px;
    }
    #chart {
     	width: 100%;
     	height: 90%;
    }
	.center{text-align: center;}
	 #upload {display: none;}
</style>
</head>

<body>


<div id="main">
<header>
    <h1>欢迎光临<mark>徐明君</mark>的个人主页</h1>
        <img class="box" id="me" src="img/me.png"></img>
</header>
<ul id="interest">
<li class="box">
	<article>
		<header class="center">国风·郑风·子衿</header>
		<p>青青子衿，悠悠我心。纵我不往，子宁不嗣音？</p>
		<p>青青子佩，悠悠我思。纵我不往，子宁不来？</p>
		<p>挑兮达兮，在城阙兮。一日不见，如三月兮。</p>
	</article>
</li>
<li class="box" ><div id="chart"></div></li>
<li class="box" >
	<form id="form" action="data/files" method="post" 
		enctype="multipart/form-data" target="upload">
		<input type="file" id="file" name="file" multiple />
		<button type="submit">Upload</button>
		<a href="#" id="fileLink">#</a>
	</form>
	<iframe id="upload" name="upload" ></iframe>
</li>
</ul>
	<div style="clear:both;">
	关注我：
	<ul class="follow">
		<li>
		    <a href="http://weibo.com/cantycando" target="_blank">
				<img src="http://weibo.com/favicon.ico" alt="weibo"></img>
			</a>
		</li>
		<li>
		    <a href="http://www.renren.com/mingjunx" target="_blank">
		    	<img src="http://a.xnimg.cn/favicon-rr.ico"></img>
		    </a>
		</li>
		<li>
		    <a href="https://twitter.com/#!/MingjunXu" target="_blank">
		    	<img src="img/tw1tter.png"></img>
		    </a>
		</li>
		<li>
		    <a href="https://www.facebook.com/MingjunXu" target="_blank">
		    	<img src="img/faceb00k.png"></img>
		    </a>
		</li>
		<li>
		    <a href="http://tw.battle.net/wow/zh/character/%E5%B1%A0%E9%AD%94%E5%B1%B1%E8%B0%B7/%E6%A5%8A%E8%B6%85/simple"
		        target="_blank">
		    	<img src="img/faceb00k.png"></img>
		    </a>
		</li>
	</ul>
	</div>
</div>

<footer>
<ul class="nav">
	<li>
	    <span class="email">
		    <a href="mailto:mr DOT xu DOT mingjun AT gmail DOT com" target="_blank">Email</a>
	    </span>
	</li>
	<li>
		<span class="xmj">
	    <a href="http://about.xumingjun.name" target="_blank">About</a>
	    </span>
	</li>
</ul>
<address>
   	Building 10, 399# Keyuan Road. Shanghai, 201203, China
</address>
</footer>
<script type="text/javascript" src="js/dojo/dojo.js" data-dojo-config="async:true"></script>
<script type="text/javascript" src="js/xmj/xmj.js"></script>
<script type="text/javascript">
require([
	"dojo/domReady",
	"dojo/dom",
	"dojo/dom-class",
	"dojo/json",
	"dojo/on",
	"dojo/_base/xhr",
	"dojo/_base/lang",
	"dojox/charting/Chart",
	"dojox/charting/themes/ThreeD",
	"dojox/charting/axis2d/Default",
	"dojox/charting/plot2d/Markers"
],
function(ready, dom, domClass, json, on, xhr, lang, Chart, ThreeD) {
	ready(function () {

		xhr("GET", {url: "data/host/statistics", handleAs: "json"}).then(function(statistics) {
			console.log(json.stringify(statistics));

			var customTheme = ThreeD.clone();
			customTheme.plotarea.fill = "#fed";

			var chart1 = new Chart("chart").
				setTheme(customTheme).
			    addAxis("x", {
			    	title: "时间",
			    	titleOrientation: "away",
			    	labels: statistics.xAxisLables ,
			    	fixLower: "major", fixUpper: "major", natural: true, includeZero: false
			    	}).
			    addAxis("y", {
			    	title: "访问量",
			    	vertical: true, fixLower: "major", fixUpper: "major", natural: true, includeZero: true}).
			    addPlot("default", {type: "Markers"}).
			    addSeries("over-all", statistics.points).
			    render();

		});
		
		var cbs = {
			onmessage: function(evt) {
				var obj = json.parse(evt.data);
				if(obj.messageType === "UploadedResult") {
					var link = dom.byId("fileLink");
					
					link.innerHTML = obj.details[0].uploadedName;
					link.href = obj.details[0].uploadedUrl;
				}
				console.log(evt.data);  
		    },  
			onclose: function(evt) {  
				console.log("close", evt);
		    },
			onopen: function(evt) {  
				console.log("open");  
			},
			onerror: function() {
				console.log("error");
			}
		};
   		var ws = null;
   		on(dom.byId("form"), "submit", function(e){
   			console.log("onsubmit", this, e);
   			ws = createWs();
  		});
   		on(dom.byId("upload"), "load", function(e){
   			console.log('upload done');
   			setTimeout(function(){
   				if(ws) {
   	   				ws.close();
   	   				ws = null;
   	   			}
   			}, 1000);
   			
   		});
   		function createWs() {
   			var url = "ws:"+location.hostname + ":8080"+"/data/files/status";
   		    var ws = new (WebSocket || MozWebSocket || Function)(url);
   		    console.log(url, ws);
   		    lang.mixin(ws, cbs);
   		    return ws;
   		}
	   	//});
	});
});
</script>
</body>
</html>
